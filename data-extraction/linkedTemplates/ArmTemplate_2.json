{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Data Factory name",
			"defaultValue": "data-extraction"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/OnPremExtraction')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Copy country data",
						"type": "Copy",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"source": {
								"type": "SqlServerSource",
								"queryTimeout": "02:00:00",
								"partitionOption": "None"
							},
							"sink": {
								"type": "ParquetSink",
								"storeSettings": {
									"type": "AzureBlobStorageWriteSettings"
								},
								"formatSettings": {
									"type": "ParquetWriteSettings"
								}
							},
							"enableStaging": false,
							"translator": {
								"type": "TabularTranslator",
								"typeConversion": true,
								"typeConversionSettings": {
									"allowDataTruncation": true,
									"treatBooleanAsNumber": false
								}
							}
						},
						"inputs": [
							{
								"referenceName": "SqlServerTable1",
								"type": "DatasetReference",
								"parameters": {}
							}
						],
						"outputs": [
							{
								"referenceName": "OnPremCountry",
								"type": "DatasetReference",
								"parameters": {}
							}
						]
					},
					{
						"name": "Copy covid metric data",
						"type": "Copy",
						"dependsOn": [
							{
								"activity": "Copy country data",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"source": {
								"type": "SqlServerSource",
								"queryTimeout": "02:00:00",
								"partitionOption": "None"
							},
							"sink": {
								"type": "ParquetSink",
								"storeSettings": {
									"type": "AzureBlobStorageWriteSettings"
								},
								"formatSettings": {
									"type": "ParquetWriteSettings"
								}
							},
							"enableStaging": false,
							"translator": {
								"type": "TabularTranslator",
								"typeConversion": true,
								"typeConversionSettings": {
									"allowDataTruncation": true,
									"treatBooleanAsNumber": false
								}
							}
						},
						"inputs": [
							{
								"referenceName": "SqlServerTable2",
								"type": "DatasetReference",
								"parameters": {}
							}
						],
						"outputs": [
							{
								"referenceName": "OnPremCovid",
								"type": "DatasetReference",
								"parameters": {}
							}
						]
					},
					{
						"name": "Copy dates data",
						"type": "Copy",
						"dependsOn": [
							{
								"activity": "Copy covid metric data",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"source": {
								"type": "SqlServerSource",
								"queryTimeout": "02:00:00",
								"partitionOption": "None"
							},
							"sink": {
								"type": "ParquetSink",
								"storeSettings": {
									"type": "AzureBlobStorageWriteSettings"
								},
								"formatSettings": {
									"type": "ParquetWriteSettings"
								}
							},
							"enableStaging": false,
							"translator": {
								"type": "TabularTranslator",
								"typeConversion": true,
								"typeConversionSettings": {
									"allowDataTruncation": true,
									"treatBooleanAsNumber": false
								}
							}
						},
						"inputs": [
							{
								"referenceName": "SqlServerTable3",
								"type": "DatasetReference",
								"parameters": {}
							}
						],
						"outputs": [
							{
								"referenceName": "OnPremDates",
								"type": "DatasetReference",
								"parameters": {}
							}
						]
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"annotations": [],
				"lastPublishTime": "2023-03-25T21:15:45Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/CasesDeathsRecoveriesDF')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "AzureSQLMetrics",
								"type": "DatasetReference"
							},
							"name": "AzureSQLMetrics"
						},
						{
							"dataset": {
								"referenceName": "OnPremCovid",
								"type": "DatasetReference"
							},
							"name": "OnPremCovid"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "recoveriesdata",
								"type": "DatasetReference"
							},
							"name": "sink1"
						},
						{
							"dataset": {
								"referenceName": "deathsdata",
								"type": "DatasetReference"
							},
							"name": "sink2"
						},
						{
							"dataset": {
								"referenceName": "casesdata",
								"type": "DatasetReference"
							},
							"name": "sink3"
						}
					],
					"transformations": [
						{
							"name": "union1"
						},
						{
							"name": "cases"
						},
						{
							"name": "deaths"
						},
						{
							"name": "recoveries"
						},
						{
							"name": "select2"
						},
						{
							"name": "filter1"
						}
					],
					"scriptLines": [
						"source(output(",
						"          ID as integer,",
						"          Updated as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer,",
						"          Deaths as integer,",
						"          Deaths_Change as integer,",
						"          Recovered as integer,",
						"          Recovered_Change as integer,",
						"          Latitude as decimal(10,5),",
						"          Longitude as decimal(10,5),",
						"          ISO2 as string,",
						"          ISO3 as string,",
						"          Country_Region as string,",
						"          load_time as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> AzureSQLMetrics",
						"source(output(",
						"          ID as integer,",
						"          Updated as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer,",
						"          Deaths as integer,",
						"          Deaths_Change as integer,",
						"          Recovered as integer,",
						"          Recovered_Change as integer,",
						"          Latitude as decimal(10,5),",
						"          Longitude as decimal(10,5),",
						"          ISO2 as string,",
						"          ISO3 as string,",
						"          Country_Region as string,",
						"          load_time as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> OnPremCovid",
						"AzureSQLMetrics, OnPremCovid union(byName: true)~> union1",
						"filter1 select(mapColumn(",
						"          CountryCode,",
						"          Date,",
						"          Confirmed,",
						"          Confirmed_Change",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> cases",
						"filter1 select(mapColumn(",
						"          CountryCode,",
						"          Date,",
						"          Deaths,",
						"          Deaths_Change",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> deaths",
						"filter1 select(mapColumn(",
						"          CountryCode,",
						"          Date,",
						"          Recovered,",
						"          Recovered_Change",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> recoveries",
						"union1 select(mapColumn(",
						"          ID,",
						"          Date = Updated,",
						"          Confirmed,",
						"          Confirmed_Change,",
						"          Deaths,",
						"          Deaths_Change,",
						"          Recovered,",
						"          Recovered_Change,",
						"          Latitude,",
						"          Longitude,",
						"          ISO2,",
						"          CountryCode = ISO3,",
						"          CountryName = Country_Region,",
						"          load_time",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> select2",
						"select2 filter(isNull(CountryCode) == false()) ~> filter1",
						"recoveries sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          CountryCode as string,",
						"          Date as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer",
						"     ),",
						"     format: 'parquet',",
						"     partitionFileNames:['recoveries.parquet'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sink1",
						"deaths sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          CountryCode as string,",
						"          Date as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer",
						"     ),",
						"     format: 'parquet',",
						"     partitionFileNames:['deaths.parquet'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sink2",
						"cases sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          CountryCode as string,",
						"          Date as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer",
						"     ),",
						"     format: 'parquet',",
						"     partitionFileNames:['cases.parquet'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sink3"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Dates')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "CosmosDBPolicy",
								"type": "DatasetReference"
							},
							"name": "Dates"
						},
						{
							"dataset": {
								"referenceName": "OnPremDates",
								"type": "DatasetReference"
							},
							"name": "OnPremDates"
						},
						{
							"dataset": {
								"referenceName": "AzureSQLDates",
								"type": "DatasetReference"
							},
							"name": "AzureSQLDates"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "ODSDates",
								"type": "DatasetReference"
							},
							"name": "sink1"
						}
					],
					"transformations": [
						{
							"name": "select1"
						},
						{
							"name": "union1"
						},
						{
							"name": "join1"
						},
						{
							"name": "select2"
						}
					],
					"scriptLines": [
						"source(output(",
						"          CountryName as string,",
						"          CountryCode as string,",
						"          RegionName as string,",
						"          RegionCode as string,",
						"          Jurisdiction as string,",
						"          Date as date,",
						"          {C1_School closing} as integer,",
						"          C1_Flag as integer,",
						"          {C2_Workplace closing} as integer,",
						"          C2_Flag as integer,",
						"          {C3_Cancel public events} as integer,",
						"          C3_Flag as integer,",
						"          {C4_Restrictions on gatherings} as integer,",
						"          C4_Flag as integer,",
						"          {C5_Close public transport} as integer,",
						"          C5_Flag as integer,",
						"          {C6_Stay at home requirements} as integer,",
						"          C6_Flag as integer,",
						"          {C7_Restrictions on internal movement} as integer,",
						"          C7_Flag as integer,",
						"          {C8_International travel controls} as integer,",
						"          {E1_Income support} as integer,",
						"          E1_Flag as integer,",
						"          {E2_Debt contract relief} as integer,",
						"          {E3_Fiscal measures} as integer,",
						"          {E4_International support} as integer,",
						"          {H1_Public information campaigns} as integer,",
						"          H1_Flag as integer,",
						"          {H2_Testing policy} as integer,",
						"          {H3_Contact tracing} as integer,",
						"          {H4_Emergency investment in healthcare} as integer,",
						"          {H5_Investment in vaccines} as integer,",
						"          {H6_Facial Coverings} as integer,",
						"          H6_Flag as integer,",
						"          {H7_Vaccination policy} as integer,",
						"          H7_Flag as integer,",
						"          {H8_Protection of elderly people} as integer,",
						"          H8_Flag as integer,",
						"          M1_Wildcard as integer,",
						"          StringencyIndex as integer,",
						"          StringencyIndexForDisplay as integer,",
						"          StringencyLegacyIndex as integer,",
						"          StringencyLegacyIndexForDisplay as integer,",
						"          GovernmentResponseIndex as integer,",
						"          GovernmentResponseIndexForDisplay as integer,",
						"          ContainmentHealthIndex as integer,",
						"          ContainmentHealthIndexForDisplay as integer,",
						"          EconomicSupportIndex as integer,",
						"          EconomicSupportIndexForDisplay as integer,",
						"          id as string,",
						"          {_rid} as string,",
						"          {_self} as string,",
						"          {_etag} as string,",
						"          {_attachments} as string,",
						"          {_ts} as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     documentForm: 'documentPerLine') ~> Dates",
						"source(output(",
						"          DateKey as integer,",
						"          FullDate as date,",
						"          isWeekDay as boolean,",
						"          DayOfWeek as integer,",
						"          DayOfMonth as integer,",
						"          DayOfQuarter as integer,",
						"          DayOfYear as integer,",
						"          DayName as string,",
						"          WeekOfYear as integer,",
						"          WeekName as string,",
						"          MonthOfYear as integer,",
						"          MonthName as string,",
						"          CalendarQuarter as integer,",
						"          CalendarQuarterName as string,",
						"          CalendarYear as integer,",
						"          FiscalMonth as integer,",
						"          FiscalMonthName as string,",
						"          FiscalQuarter as integer,",
						"          FiscalQuarterName as string,",
						"          FiscalYear as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> OnPremDates",
						"source(output(",
						"          DateKey as integer,",
						"          FullDate as date,",
						"          isWeekDay as boolean,",
						"          DayOfWeek as integer,",
						"          DayOfMonth as integer,",
						"          DayOfQuarter as integer,",
						"          DayOfYear as integer,",
						"          DayName as string,",
						"          WeekOfYear as integer,",
						"          WeekName as string,",
						"          MonthOfYear as integer,",
						"          MonthName as string,",
						"          CalendarQuarter as integer,",
						"          CalendarQuarterName as string,",
						"          CalendarYear as integer,",
						"          FiscalMonth as integer,",
						"          FiscalMonthName as string,",
						"          FiscalQuarter as integer,",
						"          FiscalQuarterName as string,",
						"          FiscalYear as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> AzureSQLDates",
						"Dates select(mapColumn(",
						"          Date",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> select1",
						"OnPremDates, AzureSQLDates union(byName: true)~> union1",
						"select1, select2 join(select1@Date == select2@Date,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> join1",
						"union1 select(mapColumn(",
						"          DateKey,",
						"          Date = FullDate,",
						"          isWeekDay,",
						"          DayOfWeek,",
						"          DayOfMonth,",
						"          DayOfQuarter,",
						"          DayOfYear,",
						"          DayName,",
						"          WeekOfYear,",
						"          WeekName,",
						"          MonthOfYear,",
						"          MonthName,",
						"          CalendarQuarter,",
						"          CalendarQuarterName,",
						"          CalendarYear,",
						"          FiscalMonth,",
						"          FiscalMonthName,",
						"          FiscalQuarter,",
						"          FiscalQuarterName,",
						"          FiscalYear",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> select2",
						"join1 sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          CountryCode as string,",
						"          Date as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer",
						"     ),",
						"     format: 'parquet',",
						"     partitionFileNames:['dates.parquet'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sink1"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/GeographyDF')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "AzureSQLCountry",
								"type": "DatasetReference"
							},
							"name": "AzureSQLCountry"
						},
						{
							"dataset": {
								"referenceName": "OnPremCountry",
								"type": "DatasetReference"
							},
							"name": "OnPremCountry"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "countrydata",
								"type": "DatasetReference"
							},
							"name": "sink1"
						}
					],
					"transformations": [
						{
							"name": "country"
						}
					],
					"scriptLines": [
						"source(output(",
						"          Country as string,",
						"          CountryCode as string,",
						"          Latitude as decimal(10,5),",
						"          Longitude as decimal(10,5)",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> AzureSQLCountry",
						"source(output(",
						"          Country as string,",
						"          CountryCode as string,",
						"          Latitude as decimal(10,5),",
						"          Longitude as decimal(10,5)",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> OnPremCountry",
						"AzureSQLCountry, OnPremCountry union(byName: true)~> country",
						"country sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          CountryCode as string,",
						"          Date as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer",
						"     ),",
						"     format: 'parquet',",
						"     partitionFileNames:['country.parquet'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sink1"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/ODS Creation')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "AzureSQLCountry",
								"type": "DatasetReference"
							},
							"name": "AzureSQLCountry"
						},
						{
							"dataset": {
								"referenceName": "AzureSQLMetrics",
								"type": "DatasetReference"
							},
							"name": "AzureSQLMetrics"
						},
						{
							"dataset": {
								"referenceName": "AzureSQLDates",
								"type": "DatasetReference"
							},
							"name": "AzureSQLDates"
						},
						{
							"dataset": {
								"referenceName": "CosmosDBPolicy",
								"type": "DatasetReference"
							},
							"name": "CosmosDBPolicy"
						},
						{
							"dataset": {
								"referenceName": "OnPremCountry",
								"type": "DatasetReference"
							},
							"name": "OnPremCountry"
						},
						{
							"dataset": {
								"referenceName": "OnPremCovid",
								"type": "DatasetReference"
							},
							"name": "OnPremCovid"
						},
						{
							"dataset": {
								"referenceName": "OnPremDates",
								"type": "DatasetReference"
							},
							"name": "OnPremDates"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "FullCountryDataSinkODS",
								"type": "DatasetReference"
							},
							"name": "sinkFullCountryData",
							"description": "put the country data in the covid data lake ods"
						},
						{
							"dataset": {
								"referenceName": "FullDatesDataSinkODS",
								"type": "DatasetReference"
							},
							"name": "sinkFullDatesData",
							"description": "sink dates data to covid data lake ods"
						},
						{
							"dataset": {
								"referenceName": "FullMetricsDataSinkODS",
								"type": "DatasetReference"
							},
							"name": "sinkFullMetricsData"
						}
					],
					"transformations": [
						{
							"name": "combAzureSQLCountry"
						},
						{
							"name": "selectcountries"
						},
						{
							"name": "FullCombinedCountry"
						},
						{
							"name": "selectdates"
						},
						{
							"name": "dateformat"
						},
						{
							"name": "combAzureSQLDates"
						},
						{
							"name": "FullCombinedDates"
						},
						{
							"name": "selectmetrics"
						},
						{
							"name": "combAzureSQLMetrics"
						},
						{
							"name": "cosmosmetrics"
						},
						{
							"name": "SQLMetrics"
						},
						{
							"name": "joinedmetricswithcountry"
						},
						{
							"name": "metrics1"
						},
						{
							"name": "FullCombinedMetrics"
						},
						{
							"name": "selectmetricstosink"
						}
					],
					"scriptLines": [
						"parameters{",
						"     columnnaming as string (\"Date\")",
						"}",
						"source(output(",
						"          Country as string,",
						"          CountryCode as string,",
						"          Latitude as decimal(10,5),",
						"          Longitude as decimal(10,5)",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> AzureSQLCountry",
						"source(output(",
						"          ID as integer,",
						"          Updated as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer,",
						"          Deaths as integer,",
						"          Deaths_Change as integer,",
						"          Recovered as integer,",
						"          Recovered_Change as integer,",
						"          Latitude as decimal(10,5),",
						"          Longitude as decimal(10,5),",
						"          ISO2 as string,",
						"          ISO3 as string,",
						"          Country_Region as string,",
						"          load_time as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> AzureSQLMetrics",
						"source(output(",
						"          DateKey as integer,",
						"          FullDate as date,",
						"          isWeekDay as boolean,",
						"          DayOfWeek as integer,",
						"          DayOfMonth as integer,",
						"          DayOfQuarter as integer,",
						"          DayOfYear as integer,",
						"          DayName as string,",
						"          WeekOfYear as integer,",
						"          WeekName as string,",
						"          MonthOfYear as integer,",
						"          MonthName as string,",
						"          CalendarQuarter as integer,",
						"          CalendarQuarterName as string,",
						"          CalendarYear as integer,",
						"          FiscalMonth as integer,",
						"          FiscalMonthName as string,",
						"          FiscalQuarter as integer,",
						"          FiscalQuarterName as string,",
						"          FiscalYear as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     format: 'parquet') ~> AzureSQLDates",
						"source(output(",
						"          CountryName as string,",
						"          CountryCode as string,",
						"          RegionName as string,",
						"          RegionCode as string,",
						"          Jurisdiction as string,",
						"          Date as string,",
						"          {C1_School closing} as integer,",
						"          C1_Flag as integer,",
						"          {C2_Workplace closing} as integer,",
						"          C2_Flag as integer,",
						"          {C3_Cancel public events} as integer,",
						"          C3_Flag as integer,",
						"          {C4_Restrictions on gatherings} as integer,",
						"          C4_Flag as integer,",
						"          {C5_Close public transport} as integer,",
						"          C5_Flag as integer,",
						"          {C6_Stay at home requirements} as integer,",
						"          C6_Flag as integer,",
						"          {C7_Restrictions on internal movement} as integer,",
						"          C7_Flag as integer,",
						"          {C8_International travel controls} as integer,",
						"          {E1_Income support} as integer,",
						"          E1_Flag as integer,",
						"          {E2_Debt contract relief} as integer,",
						"          {E3_Fiscal measures} as integer,",
						"          {E4_International support} as integer,",
						"          {H1_Public information campaigns} as integer,",
						"          H1_Flag as integer,",
						"          {H2_Testing policy} as integer,",
						"          {H3_Contact tracing} as integer,",
						"          {H4_Emergency investment in healthcare} as integer,",
						"          {H5_Investment in vaccines} as integer,",
						"          {H6_Facial Coverings} as integer,",
						"          H6_Flag as integer,",
						"          {H7_Vaccination policy} as integer,",
						"          H7_Flag as integer,",
						"          {H8_Protection of elderly people} as integer,",
						"          H8_Flag as integer,",
						"          M1_Wildcard as integer,",
						"          StringencyIndex as integer,",
						"          StringencyIndexForDisplay as integer,",
						"          StringencyLegacyIndex as integer,",
						"          StringencyLegacyIndexForDisplay as integer,",
						"          GovernmentResponseIndex as integer,",
						"          GovernmentResponseIndexForDisplay as integer,",
						"          ContainmentHealthIndex as integer,",
						"          ContainmentHealthIndexForDisplay as integer,",
						"          EconomicSupportIndex as integer,",
						"          EconomicSupportIndexForDisplay as integer,",
						"          id as string,",
						"          {_rid} as string,",
						"          {_self} as string,",
						"          {_etag} as string,",
						"          {_attachments} as string,",
						"          {_ts} as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     documentForm: 'documentPerLine') ~> CosmosDBPolicy",
						"source(output(",
						"          Country as string,",
						"          CountryCode as string,",
						"          Latitude as decimal(10,5),",
						"          Longitude as decimal(10,5)",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: true,",
						"     format: 'parquet') ~> OnPremCountry",
						"source(output(",
						"          ID as integer,",
						"          Updated as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer,",
						"          Deaths as integer,",
						"          Deaths_Change as integer,",
						"          Recovered as integer,",
						"          Recovered_Change as integer,",
						"          Latitude as decimal(10,5),",
						"          Longitude as decimal(10,5),",
						"          ISO2 as string,",
						"          ISO3 as string,",
						"          Country_Region as string,",
						"          load_time as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: true,",
						"     format: 'parquet') ~> OnPremCovid",
						"source(output(",
						"          DateKey as integer,",
						"          FullDate as date,",
						"          isWeekDay as boolean,",
						"          DayOfWeek as integer,",
						"          DayOfMonth as integer,",
						"          DayOfQuarter as integer,",
						"          DayOfYear as integer,",
						"          DayName as string,",
						"          WeekOfYear as integer,",
						"          WeekName as string,",
						"          MonthOfYear as integer,",
						"          MonthName as string,",
						"          CalendarQuarter as integer,",
						"          CalendarQuarterName as string,",
						"          CalendarYear as integer,",
						"          FiscalMonth as integer,",
						"          FiscalMonthName as string,",
						"          FiscalQuarter as integer,",
						"          FiscalQuarterName as string,",
						"          FiscalYear as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: true,",
						"     format: 'parquet') ~> OnPremDates",
						"AzureSQLCountry, OnPremCountry union(byName: true)~> combAzureSQLCountry",
						"CosmosDBPolicy select(mapColumn(",
						"          Country = CountryName,",
						"          CountryCode",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectcountries",
						"combAzureSQLCountry, selectcountries union(byName: true)~> FullCombinedCountry",
						"CosmosDBPolicy select(mapColumn(",
						"          Date",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectdates",
						"selectdates cast(output(",
						"          Date as date 'yyyy-MM-dd'",
						"     ),",
						"     errors: true) ~> dateformat",
						"AzureSQLDates, OnPremDates union(byName: true)~> combAzureSQLDates",
						"combAzureSQLDates, dateformat union(byName: true)~> FullCombinedDates",
						"CosmosDBPolicy select(mapColumn(",
						"          Date,",
						"          CountryCode,",
						"          {C1_School closing},",
						"          {C2_Workplace closing},",
						"          {C3_Cancel public events},",
						"          {C4_Restrictions on gatherings},",
						"          {C5_Close public transport},",
						"          {C6_Stay at home requirements},",
						"          {C7_Restrictions on internal movement},",
						"          {C8_International travel controls},",
						"          {E1_Income support},",
						"          {E2_Debt contract relief},",
						"          {E3_Fiscal measures},",
						"          {E4_International support},",
						"          {H1_Public information campaigns},",
						"          {H2_Testing policy},",
						"          {H3_Contact tracing},",
						"          {H4_Emergency investment in healthcare},",
						"          {H5_Investment in vaccines},",
						"          {H6_Facial Coverings},",
						"          {H7_Vaccination policy},",
						"          {H8_Protection of elderly people},",
						"          M1_Wildcard,",
						"          StringencyIndex,",
						"          GovernmentResponseIndex,",
						"          ContainmentHealthIndex,",
						"          EconomicSupportIndex,",
						"          id",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectmetrics",
						"AzureSQLMetrics, OnPremCovid union(byName: true)~> combAzureSQLMetrics",
						"selectmetrics cast(output(",
						"          Date as date 'yyyy-MM-dd'",
						"     ),",
						"     errors: true) ~> cosmosmetrics",
						"combAzureSQLMetrics select(mapColumn(",
						"          ID,",
						"          Date = Updated,",
						"          Confirmed,",
						"          Confirmed_Change,",
						"          Deaths,",
						"          Deaths_Change,",
						"          Recovered,",
						"          Recovered_Change,",
						"          Latitude,",
						"          Longitude,",
						"          ISO2,",
						"          ISO3,",
						"          Country_Region,",
						"          load_time",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> SQLMetrics",
						"cosmosmetrics, FullCombinedCountry join(selectmetrics@CountryCode == FullCombinedCountry@CountryCode,",
						"     joinType:'right',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> joinedmetricswithcountry",
						"joinedmetricswithcountry select(mapColumn(",
						"          Date,",
						"          {C1_School closing},",
						"          {C2_Workplace closing},",
						"          {C3_Cancel public events},",
						"          {C4_Restrictions on gatherings},",
						"          {C5_Close public transport},",
						"          {C6_Stay at home requirements},",
						"          {C7_Restrictions on internal movement},",
						"          {C8_International travel controls},",
						"          {E1_Income support},",
						"          {E2_Debt contract relief},",
						"          {E3_Fiscal measures},",
						"          {E4_International support},",
						"          {H1_Public information campaigns},",
						"          {H2_Testing policy},",
						"          {H3_Contact tracing},",
						"          {H4_Emergency investment in healthcare},",
						"          {H5_Investment in vaccines},",
						"          {H6_Facial Coverings},",
						"          {H7_Vaccination policy},",
						"          {H8_Protection of elderly people},",
						"          M1_Wildcard,",
						"          StringencyIndex,",
						"          GovernmentResponseIndex,",
						"          ContainmentHealthIndex,",
						"          EconomicSupportIndex,",
						"          id,",
						"          Country,",
						"          CountryCode = FullCombinedCountry@CountryCode,",
						"          Latitude,",
						"          Longitude",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> metrics1",
						"metrics1, SQLMetrics join(metrics1@Date == SQLMetrics@Date,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> FullCombinedMetrics",
						"FullCombinedMetrics select(mapColumn(",
						"          Date = metrics1@Date,",
						"          C1Schoolclosing = {C1_School closing},",
						"          C2Workplaceclosing = {C2_Workplace closing},",
						"          C3Cancelpublicevents = {C3_Cancel public events},",
						"          C4Restrictionsongatherings = {C4_Restrictions on gatherings},",
						"          C5Closepublictransport = {C5_Close public transport},",
						"          C6Stayathomerequirements = {C6_Stay at home requirements},",
						"          C7Restrictionsoninternalmovement = {C7_Restrictions on internal movement},",
						"          C8Internationaltravelcontrols = {C8_International travel controls},",
						"          E1incomesupport = {E1_Income support},",
						"          E2Debtcontractrelief = {E2_Debt contract relief},",
						"          E3Fiscalmeasures = {E3_Fiscal measures},",
						"          E4Internationalsupport = {E4_International support},",
						"          H1Publicinformationcampaigns = {H1_Public information campaigns},",
						"          H2Testingpolicy = {H2_Testing policy},",
						"          H3Contacttracing = {H3_Contact tracing},",
						"          H4Emergencyinvestmentinhealthcare = {H4_Emergency investment in healthcare},",
						"          H5Investmentinvaccines = {H5_Investment in vaccines},",
						"          H6FacialCoverings = {H6_Facial Coverings},",
						"          H7Vaccinationpolicy = {H7_Vaccination policy},",
						"          H8Protectionofelderlypeople = {H8_Protection of elderly people},",
						"          M1Wildcard = M1_Wildcard,",
						"          StringencyIndex,",
						"          GovernmentResponseIndex,",
						"          ContainmentHealthIndex,",
						"          EconomicSupportIndex,",
						"          id = metrics1@id,",
						"          Country,",
						"          CountryCode,",
						"          Latitude = metrics1@Latitude,",
						"          Longitude = metrics1@Longitude,",
						"          ID = SQLMetrics@ID,",
						"          Date = SQLMetrics@Date,",
						"          Confirmed,",
						"          Confirmed_Change,",
						"          Deaths,",
						"          Deaths_Change,",
						"          Recovered,",
						"          Recovered_Change,",
						"          Latitude = SQLMetrics@Latitude,",
						"          Longitude = SQLMetrics@Longitude,",
						"          ISO2,",
						"          ISO3,",
						"          Country_Region,",
						"          load_time",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectmetricstosink",
						"FullCombinedCountry sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     partitionFileNames:['sinkFullCountryData'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sinkFullCountryData",
						"FullCombinedDates sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     partitionFileNames:['sinkFullDatesData'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sinkFullDatesData",
						"selectmetricstosink sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     partitionFileNames:['sinkFullMetricsData'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sinkFullMetricsData"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/PolicyDF')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "CosmosDBPolicy",
								"type": "DatasetReference"
							},
							"name": "PolicyData"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "policydata",
								"type": "DatasetReference"
							},
							"name": "sink1"
						}
					],
					"transformations": [
						{
							"name": "policy"
						}
					],
					"scriptLines": [
						"source(output(",
						"          CountryName as string,",
						"          CountryCode as string,",
						"          RegionName as string,",
						"          RegionCode as string,",
						"          Jurisdiction as string,",
						"          Date as date,",
						"          {C1_School closing} as integer,",
						"          C1_Flag as integer,",
						"          {C2_Workplace closing} as integer,",
						"          C2_Flag as integer,",
						"          {C3_Cancel public events} as integer,",
						"          C3_Flag as integer,",
						"          {C4_Restrictions on gatherings} as integer,",
						"          C4_Flag as integer,",
						"          {C5_Close public transport} as integer,",
						"          C5_Flag as integer,",
						"          {C6_Stay at home requirements} as integer,",
						"          C6_Flag as integer,",
						"          {C7_Restrictions on internal movement} as integer,",
						"          C7_Flag as integer,",
						"          {C8_International travel controls} as integer,",
						"          {E1_Income support} as integer,",
						"          E1_Flag as integer,",
						"          {E2_Debt contract relief} as integer,",
						"          {E3_Fiscal measures} as integer,",
						"          {E4_International support} as integer,",
						"          {H1_Public information campaigns} as integer,",
						"          H1_Flag as integer,",
						"          {H2_Testing policy} as integer,",
						"          {H3_Contact tracing} as integer,",
						"          {H4_Emergency investment in healthcare} as integer,",
						"          {H5_Investment in vaccines} as integer,",
						"          {H6_Facial Coverings} as integer,",
						"          H6_Flag as integer,",
						"          {H7_Vaccination policy} as integer,",
						"          H7_Flag as integer,",
						"          {H8_Protection of elderly people} as integer,",
						"          H8_Flag as integer,",
						"          M1_Wildcard as integer,",
						"          StringencyIndex as integer,",
						"          StringencyIndexForDisplay as integer,",
						"          StringencyLegacyIndex as integer,",
						"          StringencyLegacyIndexForDisplay as integer,",
						"          GovernmentResponseIndex as integer,",
						"          GovernmentResponseIndexForDisplay as integer,",
						"          ContainmentHealthIndex as integer,",
						"          ContainmentHealthIndexForDisplay as integer,",
						"          EconomicSupportIndex as integer,",
						"          EconomicSupportIndexForDisplay as integer,",
						"          id as string,",
						"          {_rid} as string,",
						"          {_self} as string,",
						"          {_etag} as string,",
						"          {_attachments} as string,",
						"          {_ts} as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     documentForm: 'documentPerLine') ~> PolicyData",
						"PolicyData select(mapColumn(",
						"          CountryName,",
						"          CountryCode,",
						"          Jurisdiction,",
						"          Date,",
						"          C1_School_closing = {C1_School closing},",
						"          C1_Flag,",
						"          C2_Workplace_closing = {C2_Workplace closing},",
						"          C2_Flag,",
						"          C3_Cancel_public_events = {C3_Cancel public events},",
						"          C3_Flag,",
						"          C4_Restrictions_on_gatherings = {C4_Restrictions on gatherings},",
						"          C4_Flag,",
						"          C5_Close_public_transport = {C5_Close public transport},",
						"          C5_Flag,",
						"          C6_Stay_at_home_requirements = {C6_Stay at home requirements},",
						"          C6_Flag,",
						"          C7_Restrictions_on_internal_movement = {C7_Restrictions on internal movement},",
						"          C7_Flag,",
						"          C8_International_travel_controls = {C8_International travel controls},",
						"          E1_Income_support = {E1_Income support},",
						"          E1_Flag,",
						"          E2_Debt_contract_relief = {E2_Debt contract relief},",
						"          E3_Fiscal_measures = {E3_Fiscal measures},",
						"          E4_International_support = {E4_International support},",
						"          H1_Public_information_campaigns = {H1_Public information campaigns},",
						"          H1_Flag,",
						"          H2_Testing_policy = {H2_Testing policy},",
						"          H3_Contact_tracing = {H3_Contact tracing},",
						"          H4_Emergency_investment_in_healthcare = {H4_Emergency investment in healthcare},",
						"          H5_Investment_in_vaccines = {H5_Investment in vaccines},",
						"          H6_Facial_Coverings = {H6_Facial Coverings},",
						"          H6_Flag,",
						"          H7_Vaccination_policy = {H7_Vaccination policy},",
						"          H7_Flag,",
						"          H8_Protection_of_elderly_people = {H8_Protection of elderly people},",
						"          H8_Flag,",
						"          M1_Wildcard,",
						"          StringencyIndex,",
						"          StringencyIndexForDisplay,",
						"          StringencyLegacyIndex,",
						"          StringencyLegacyIndexForDisplay,",
						"          GovernmentResponseIndex,",
						"          GovernmentResponseIndexForDisplay,",
						"          ContainmentHealthIndex,",
						"          ContainmentHealthIndexForDisplay,",
						"          EconomicSupportIndex,",
						"          EconomicSupportIndexForDisplay",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> policy",
						"policy sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          CountryCode as string,",
						"          Date as date,",
						"          Confirmed as integer,",
						"          Confirmed_Change as integer",
						"     ),",
						"     format: 'parquet',",
						"     partitionFileNames:['policy.parquet'],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     partitionBy('hash', 1)) ~> sink1"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Data Normalization')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "CasesDeathsRecoveriesDF",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "CasesDeathsRecoveriesDF",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"AzureSQLMetrics": {},
									"OnPremCovid": {},
									"sink1": {},
									"sink2": {},
									"sink3": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					},
					{
						"name": "GeographyDF",
						"type": "ExecuteDataFlow",
						"dependsOn": [
							{
								"activity": "PolicyDF",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "GeographyDF",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"AzureSQLCountry": {},
									"OnPremCountry": {},
									"sink1": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					},
					{
						"name": "PolicyDF",
						"type": "ExecuteDataFlow",
						"dependsOn": [
							{
								"activity": "CasesDeathsRecoveriesDF",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "PolicyDF",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"PolicyData": {},
									"sink1": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					},
					{
						"name": "DatesDF",
						"type": "ExecuteDataFlow",
						"dependsOn": [
							{
								"activity": "GeographyDF",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "Dates",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"Dates": {},
									"OnPremDates": {},
									"AzureSQLDates": {},
									"sink1": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/dataflows/CasesDeathsRecoveriesDF')]",
				"[concat(variables('factoryId'), '/dataflows/GeographyDF')]",
				"[concat(variables('factoryId'), '/dataflows/PolicyDF')]",
				"[concat(variables('factoryId'), '/dataflows/Dates')]"
			]
		}
	]
}